## Authors: 
##   Christoph Doerbeck
##
## Summary:
##   Downloads and unpacks software /root for OCP installation
##

---
- hosts: myBastion
  tasks:

  # - debug:
  #     msg: "{{ item }}"
  #   with_items: 
  #     - "{{ groups['myMasters'] }}"
  #     - "{{ groups['myWorkers'] }}"

  ##
  ## For every node in cluster: 
  ##   until ( node == ready )
  ##    scan for pending CSR's
  ##    approve pending CSR's
  ##    sleep
  ##

  - name: "BASTION-OPENSHIFT-FINISH: Approve CSR requests until all nodes 'Ready'"
    shell:
      cmd: |
        export KUBECONFIG={{ g_credsDir }}/auth/kubeconfig
        if [[ `oc get node --no-headers {{ item }}.{{ g_pubFQDN }} | awk '{print $2}'` == "Ready" ]] ; then
          exit 0
        else
          for i in `oc get csr | grep -i pending | awk '{print $1}'`; do 
            oc adm certificate approve $i
            sleep 1
          done
          exit 1
        fi 
    register: result
    until:  result.rc == 0
    retries: 600
    delay: 5
    with_items: 
      - "{{ groups['myMasters'] }}"
      - "{{ groups['myWorkers'] }}"

  ##
  ## Nodes are all ready
  ## Now just watch for all clusteroperators ready
  ## There can be cases when timing is just right, that
  ## to results of 'get clusteroperators' can show all True.
  ## But that is harmless.  This cluster is "mostly" ready
  ## if this exits
  ##

  - name: "BASTION-OPENSHIFT-FINISH: Watch until all clusteroperators availability is 'True'"
    shell:
      cmd: |
        export KUBECONFIG={{ g_credsDir }}/auth/kubeconfig
        oc get clusteroperators --no-headers | awk '{print $3}' | grep -i false 
        if [[ $? == 0 ]]; then exit 1; else exit 0; fi
    register: result
    until:  result.rc == 0
    retries: 600
    delay: 5

