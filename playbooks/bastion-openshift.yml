## Authors: 
##   Christoph Doerbeck
##
## Summary:
##   Downloads and unpacks software /root for OCP installation
##

---
- hosts: myBastion
  tasks:

#  - include_vars: "{{ item }}"
#    with_first_found:  "{{ vars_openshift }}"

  - name: "BASTION-OPENSHIFT: Create openshift working directory"
    file:
      path: "{{ g_credsDir }}"
      mode: "0755"
      state: directory

## If deploying via the ws-deployer-kvm, pull_secret may already ben installed
## Otherwise this is a manual step, following instructions as noted below

  - name: "BASTION-OPENSHIFT: stat pull-secret"
    stat: path="{{ g_credsDir }}/pull-secret.txt"
    register: test_pull_secret

  - debug: msg="Pull-Secret URL https://cloud.redhat.com/openshift/install/metal/user-provisioned"
    when: test_pull_secret.stat.exists == false

  - name: "BASTION-OPENSHIFT: fail if pull-secret absent"
    fail: msg="COPY YOUR OCP4 PULL-SECRET HERE {{ g_credsDir }}/pull-secret.txt"
    when: test_pull_secret.stat.exists == false

##
## libvirt just finished putting the pull secret here.  maybe don't cleanup
##
#
#  - name: "BASTION-OPENSHIFT: Clean-up ocp working directory"
#    shell:
#      cmd: |
#        if [[ -d {{ g_credsDir }} ]] ; then rm -rf {{ g_credsDir }} ; fi

  - name: "BASTION-OPENSHIFT: Create ssh directory"
    file:
      path: /root/.ssh
      mode: "0700"
      state: directory

  - name: "BASTION-OPENSHIFT: test ssh key"
    stat: path="/root/.ssh/id_rsa.pub"
    register: test_ssh_key

  - name: "BASTION-OPENSHIFT: create ssh key"
    command: "ssh-keygen -t rsa -b 2048 -N '' -f /root/.ssh/id_rsa"
    when: test_ssh_key.stat.exists == false

  - name: "BASTION-OPENSHIFT: download ocp software [SRC: {{ g_ocp_src }}]"
    environment:
      http_proxy: "{{ g_http_proxy }}"
      https_proxy: "{{ g_https_proxy }}"
    get_url:
      url: "{{ g_ocp_src }}/{{ item }}"
      dest: "/usr/local/src/{{ item }}"
      mode: "0644"
    with_items:
      - "{{ g_ocp_install }}"
      - "{{ g_ocp_client }}"

  - name: "BASTION-OPENSHIFT: unpack ocp software"
    shell:
      cmd: |
        cd /usr/local/bin
        tar zxvf /usr/local/src/{{ item }}
    with_items:
      - "{{ g_ocp_install }}"
      - "{{ g_ocp_client }}"

  - name: "BASTION-OPENSHIFT: load pull secret"
    shell: cat {{ g_credsDir }}/pull-secret.txt
    register: pull_secret

  - name: "BASTION-OPENSHIFT: load ssh key"
    shell: cat /root/.ssh/id_rsa.pub
    register: ssh_key

  - name: "BASTION-OPENSHIFT: deploy install-config.yml"
    vars:
      - p_pullSecret:   "{{ pull_secret.stdout |quote }}"
      - p_sshKey:       "{{ ssh_key.stdout |quote }}"
      - p_clusterName:  "{{ g_clusterName }}"
      - p_domain:       "{{ g_publicDomain }}"
      - p_http_proxy:   "{{ g_http_proxy | default ('') }}"
      - p_https_proxy:  "{{ g_https_proxy | default ('') }}"
      - p_no_proxy:     "{{ g_no_proxy | default ('') }}"
    template:
      src: "ocp-install-config.j2"
      dest: "{{ g_credsDir }}/install-config.yaml"
      owner: root
      group: root
      mode: 644

  - name: "BASTION-OPENSHIFT: Clean-up ignition directory"
    shell:
      cmd: |
        if [[ -d "/var/lib/matchbox/ignition/" ]] ; then rm -f /var/lib/matchbox/ignition/* ; fi

  - name: "BASTION-OPENSHIFT: create ignition files"
    shell:
      cmd: |
        cd {{ g_credsDir }}
        /usr/local/bin/openshift-install --dir={{ g_credsDir }} create ignition-configs

  - name: "BASTION-OPENSHIFT: copy ignition files"
    shell:
      cmd: |
        cp {{ g_credsDir }}/*.ign /var/lib/matchbox/ignition/

  - name: "BASTION-OPENSHIFT: fix ignition file permissions"
    shell:
      cmd: |
        chown matchbox.matchbox /var/lib/matchbox/ignition/*

  - name: "BASTION-OPENSHIFT: package installation"
    yum: name=bash-completion state=installed

  - name: "BASTION-OPENSHIFT: configure openshift bash completion"
    shell: 
      cmd: |
        /usr/local/bin/oc completion bash >> /etc/bash_completion.d/oc_completion
        /usr/local/bin/openshift-install completion bash >> /etc/bash_completion.d/openshift-install_completion

  - name: "BASTION-OPENSHIFT: DEBUG"
    debug: msg="YOU CAN NOW DEPLOY THE BOOTSTRAP"
