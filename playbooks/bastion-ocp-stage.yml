## Authors: 
##   Christoph Doerbeck
##
## Summary:
##   Downloads and unpacks software /root for OCP installation
##

---
- hosts: myBastion
  tasks:

  - name: "BASTION-OCP: stat pull secret"
    stat: path=/root/ocp4_pull_secret
    register: pull_secret

  - name: "BASTION-OCP: "
    fail: msg="COPY YOU PULL SECRET HERE /root/ocp4_pull_secret"
    when: pull_secret.stat.exists == false

  - name: "BASTION-OCP: create install working directory"
    file:
      path: /root/ocp
      mode: "0755"
      state: directory

  - name: "BASTION-OCP: test ssh key"
    stat: path=/root/.ssh/id_rsa
    register: ssk_key

#  - name: "BASTION-OCP: create ssh key"
#    shell: 
#      cmd: | 
#        ssh-keygen -t rsa -b 2048 -N '' -f /root/.ssh/id_rsa
#    when: ssh_key.stat.exists == false

  - name: "BASTION-OCP: stat ocp client software"
    stat: path=/usr/local/src/openshift-client-linux-4.2.16.tar.gz
    register: opc_client_sw

  - name: "BASTION-OCP: download client software"
    get_url:
      url: https://mirror.openshift.com/pub/openshift-v4/clients/ocp/4.2.16/openshift-client-linux-4.2.16.tar.gz
      dest: /usr/local/src/
      mode: "0644"

  - name: "BASTION-OCP: unpack client software"
    shell:
      cmd: |
        cd /usr/local/bin
        tar zxvf /usr/local/src/openshift-client-linux-4.2.16.tar.gz

  - name: "BASTION-OCP: download installer software"
    get_url:
      url: https://mirror.openshift.com/pub/openshift-v4/clients/ocp/4.2.16/openshift-install-linux-4.2.16.tar.gz 
      dest: /usr/local/src/
      mode: "0644"

  - name: "BASTION-OCP: unpack installer software"
    shell:
      cmd: |
        cd /usr/local/bin
        tar zxvf /usr/local/src/openshift-install-linux-4.2.16.tar.gz



  - name: "BASTION-OCP: deploy install-config.yml"
    vars:
      - p_clusterName:  "{{ g_clusterName }}"
      - p_domain:       "{{ g_publicDomain }}"
    template:
      src: "ocp-install-config.j2"
      dest: "/root/ocp/install-config.yaml"
      owner: root
      group: root
      mode: 644

