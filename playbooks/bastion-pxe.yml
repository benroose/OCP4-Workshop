## Authors: 
##   Christoph Doerbeck
##
## Summary:
##   This playbook configures PXE to support installation of RHCOS
##   
##   Current the model should follow:
##
##     If iPXE based, we boot from matchbox 
##     If UEFI based, we chain load with ipxe.efi and try again as iPXE
##     If  PXE based, we chain load with undionly and try again as iPXE
##
##   NOTE 1: pxelinux is installed but NOT configured.  I may switch 
##           to this in the future
##
##   NOTE 2: configuration in dhcp must match files and paths here.
##

---
- hosts: myBastion
  tasks:
  
  - name: "BASTION-PXE: package installation"
    yum: name=tftp-server,ipxe-bootimgs,syslinux-tftpboot state=installed

  - name: "BASTION-PXE: create tftpboot directories"
    file:
      path: "{{ item }}"
      mode: "0755"
      state: directory
    with_items:
      - "/var/lib/tftpboot"
      - "/var/lib/tftpboot/efi"

  - name: "BASTION-PXE: copy ipxe files to tftpboot"
    copy: 
      src:   "/usr/share/ipxe/undionly.kpxe"
      dest:  "/var/lib/tftpboot"
      mode:  "0644"
      owner: root
      group: root
      remote_src: yes
    with_items:
      - "/usr/share/ipxe/undionly.kpxe"
      - "/usr/share/ipxe/ipxe.efi"

  - name: "BASTION-PXE: restart services"
    service: name={{ item }} state=restarted enabled=yes masked=no
    with_items:
      - "tftp"

  - name: "BASTION-PXE: add firewalld services"
    firewalld:
      service: "{{ item }}"
      immediate: yes
      permanent: yes
      state: enabled
    with_items:
      - "http"
      - "https"
      - "tftp"
